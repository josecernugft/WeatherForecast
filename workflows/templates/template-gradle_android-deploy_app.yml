parameters:
  - name: 'vmImage'
    default: 'macos-latest'
    type: string

  - name: 'buildType'
    default: 'debug'
    type: string

jobs:
  - job: Build
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            yes | ~/Library/Android/sdk/tools/bin/sdkmanager --licenses --sdk_root=$ANDROID_SDK_PATH
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            echo "y" | $ANDROID_HOME/tools/bin/sdkmanager --install 'system-images;android-27;google_apis;x86'
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            $ANDROID_HOME/platform-tools/adb devices
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd -n test_android_emulator -k 'system-images;android-27;google_apis;x86' --force
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            nohup $ANDROID_HOME/emulator/emulator -avd test_android_emulator -no-snapshot > /dev/null 2>&1 &
      - task: Bash@3
        inputs:
          targetType: 'inline'
          script: |
            $ANDROID_HOME/platform-tools/adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed | tr -d '\r') ]]; do sleep 1; done; input keyevent 82'
            echo "Emulator started"